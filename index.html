<html>

<head>
    <title>
        Lions are the best
    </title>

    <style>
        img {
            image-rendering: pixelated;
        }
    </style>
</head>

<body onload=setup()>
    <h1>
		Project Lazer Lions
	</h1>

    <img src="images/Sprite2biggermane.png" width=100 id="lionImage">
    </img>

    <a href="http://reddit.com/r/lions">
		Roar
	</a>

    <p id="nameTag">
        Lions name is:
    </p>

    <p>
        Rename:
        <input id="nameTextbox" onkeypress="textBoxKeyPress(event)">
        </input>

        <input type=button value="enter" onclick=nameTheLion()>
        </input>
    </p>

    <p id="ageTag">
        Age:
    </p>

    <p id="foodTag">
        Favourite Food:
    </p>

    <p id="personalityTag">
        Personality:
        <ul id="traitsList">
            <li>
            </li>
            <li>
            </li>
            <li>
            </li>
        </ul>
    </p>

    <p>Your Lions:
        <select id="lionSelect" onchange="selectLion(this)">
        </select>
    </p>

    <input type=button value="restart" onclick=restart()>
    </input>

    <input type="range" min="0" max="23" value="0" onchange="changeColorSlider(this)">

    <p id="maneColorLabel"></p>
    <p id="eyeColorLabel"></p>
    <p id="furColorLabel"></p>

</body>

<script>
    var lions;
    var lionInfo;
    var selectedLion;

    var foods = [
        "Cookies",
        "Waffles",
        "Muffins",
        "Sour Gummy Bears",
        "Spaghetti",
        "Cheese Burger",
        "Watermelon",
        "Steak",
        "Cupcakes",
        "Bacon",
        "Sausage",
        "Chicken",
        "Fish",
        "Bread",
    ];

    var desires = [
        {
            action: "eat",
            more: "insatiable",
            less: "nibbler",
        },
        {
            action: "sleep",
            more: "lazy",
            less: "energetic",
        },
        {
            action: "play",
            more: "playful",
            less: "serious",
        },
        {
            action: "give present",
            more: "generous",
            less: "hoarder",
        },
        {
            action: "be pet",
            more: "affectionate",
            less: "reserved",
        },
        {
            action: "fight",
            more: "brave",
            less: "nervous",
        },
        {
            action: "be photographed",
            more: "proud",
            less: "shy",
        },
        {
            action: "love",
            more: "charming",
            less: "reserved",
        },
        {
            action: "befriend",
            more: "friendly",
            less: "loner",
        },
        {
            action: "have an egg",
            more: "impulsive",
            less: "cautious",
        },
        {
            action: "raise a cub",
            more: "nuturing",
            less: "free",
        },
        {
            action: "grow up",
            more: "mature",
            less: "youthful",
        },
        {
            action: "take medicine",
            more: "delicate",
            less: "hearty",
        }
    ];

    var colors = [
        "red",
        "orange",
        "yellow",
        "green",
        "miku",
        "blue",
        "purple",
        "magenta",
    ];
    
    var colors = [
        {
            name: "red",
            low: 340,
            base: 0,
            high: 10,
        },
        {
            name: "orange",
            low: 20,
            base: 30,
            high: 40,
        },
        {
            name: "yellow",
            low: 50,
            base: 60,
            high: 70,
        },
        {
            name: "green",
            low: 90,
            base: 120,
            high: 150,
        },
        {
            name: "miku",
            low: 170,
            base: 180,
            high: 190,
        },
        {
            name: "blue",
            low: 200,
            base: 220,
            high: 240,
        },
        {
            name: "purple",
            low: 270,
            base: 280,
            high: 290,
        },
        {
            name: "magenta",
            low: 300,
            base: 310,
            high: 320,
        },
    ];

    var setup = function () {
        load_from_cookie();
        lions = game_data.lions;
        if (lions) {
            selectedLion = 0;
            lionInfo = lions[selectedLion];
        } else {
            restart();
        }

        updatePage();
    };

    var restart = function () {
        createLions();
        updateSaveData();
        updatePage();
    };

    var createLions = function () {
        var lionsToCreate = 3;
        lions = [];

        var l;
        for (l = 0; l < lionsToCreate; l++) {
            var newLion = createLion();
            lions.push(newLion);
        }
        selectedLion = 0;
        lionInfo = lions[selectedLion];
    };

    var createLion = function () {
        var lionInfo = {};
        lionInfo.name = "unnamed";
        lionInfo.age = "Adult";
        //lionInfo.personalityTag=

        var foodIndex = Math.random();
        foodIndex = foodIndex * foods.length;
        foodIndex = Math.floor(foodIndex);
        console.log("foodIndex:" + foodIndex);

        lionInfo.food = foods[foodIndex];


        //deside traits
        lionInfo.traits = [];

        //creates a copy of the array
        var availableDesires = desires.slice(0);

        while (lionInfo.traits.length < 3) {

            var desireIndex = Math.floor(Math.random() * availableDesires.length);
            var desire = availableDesires[desireIndex];

            //remove the chosen one from list of available options
            availableDesires.splice(desireIndex, 1);

            var desireLevel = Math.floor(Math.random() * 2);

            var trait;
            if (desireLevel == 0) {
                trait = desire.less;
            } else {
                trait = desire.more;
            }
            lionInfo.traits.push(trait);
        }

        console.log(lionInfo.traits);

        return lionInfo;
    };

    var updatePage = function () {
        var nametag = document.getElementById("nameTag");
        var ageTag = document.getElementById("ageTag");
        var favefood = document.getElementById("foodTag");

        nametag.textContent = "Lions name is: " + lionInfo.name;
        ageTag.textContent = "Age: " + lionInfo.age;
        favefood.textContent = "Favourite Food: " + lionInfo.food;

        var nameTextbox = document.getElementById("nameTextbox");
        nameTextbox.value = "";

        updateLionSelect();
        updateTraitList();
    };

    var updateTraitList = function () {
        var traitsList = document.getElementById("traitsList");

        //remove old items
        while (traitsList.getElementsByTagName("li").length > 0) {
            traitsList.removeChild(traitsList.firstChild);
        }

        //add new items
        var loopCount = 0;
        while (loopCount < lionInfo.traits.length) {
            var trait = lionInfo.traits[loopCount];
            var traitItem = document.createElement("li");
            traitItem.textContent = trait;
            traitsList.appendChild(traitItem);

            loopCount += 1;
        }
    };

    var updateLionSelect = function () {
        var lionSelect = document.getElementById("lionSelect");

        //remove old options
        while (lionSelect.length > 0) {
            lionSelect.removeChild(lionSelect.firstChild);
        }

        //add new options
        var loopCount = 0;
        while (loopCount < lions.length) {
            var lion = lions[loopCount];
            var lionItem = document.createElement("option");
            lionItem.value = lion.name;
            lionItem.textContent = lion.name;
            lionSelect.appendChild(lionItem);

            loopCount += 1;
        }

        lionSelect.selectedIndex = selectedLion;
    };

    var textBoxKeyPress = function (event) {
        console.log(event.charCode);
        if (event.charCode == 13) {
            nameTheLion();
        }
    };

    var nameTheLion = function () {
        var nameTextbox = document.getElementById("nameTextbox");

        lionInfo.name = nameTextbox.value;

        updateSaveData();
        updatePage();
    };

    var selectLion = function (element) {
        //console.log(element.value);
        //console.log(element.selectedIndex);
        selectedLion = lionSelect.selectedIndex;

        lionInfo = lions[selectedLion];
        updatePage();
    };
    
    var changeColorSlider = function (element) {
        
        var imageTag = document.getElementById("lionImage");
        var imageSrc = "images/Sprite2biggermane.png";
        var srcWidth = 32;
        var modifiers = [];
        
        var colorIndex = Math.floor(Math.random() * 8);
        var color = colors[colorIndex];
        
        var colorTag = document.getElementById("maneColorLabel");
        colorTag.textContent = "Mane: " + color.name;
        
        var huePortion = color.base / 360.0;
        modifiers.push({
            low: 0.0,
            high: 0.05,
            add: huePortion,
        });
        
        var colorIndex = Math.floor(Math.random() * 8);
        var color = colors[colorIndex];
        
        var colorTag = document.getElementById("eyeColorLabel");
        colorTag.textContent = "Eyes: " + color.name;
        
        var huePortion = color.base / 360.0;
        modifiers.push({
            low: 0.12,
            high: 0.14,
            add: huePortion,
        });
        
        var colorIndex = Math.floor(Math.random() * 8);
        var color = colors[colorIndex];
        
        var colorTag = document.getElementById("furColorLabel");
        colorTag.textContent = "Fur: " + color.name;
        
        var huePortion = color.base / 360.0;
        modifiers.push({
            low: 0.10,
            high: 0.12,
            add: huePortion,
        });
        
        changeColor(element, imageTag, imageSrc, srcWidth, modifiers);
        
        //var hueTag = document.getElementById("colorHue");
        //var colorTag = document.getElementById("colorLabel");
    };
    
    //var changeColor = function (element) {

    var changeColor = function (element, imageTag, imageSrc, srcWidth, modifiers) {

        var img = imageTag;
        img.src = imageSrc;
        var tagWidth = img.width;
        img.width = srcWidth;

        var canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        var context = canvas.getContext('2d');
        context.drawImage(img, 0, 0, img.width, img.height);

        var imageMap = context.getImageData(0, 0, img.width, img.height);
        var imageData = imageMap.data;


        var p, r, g, b, h, s, l;
        for (p = 0; p < imageData.length; p += 4) {
            r = imageData[p];
            g = imageData[p + 1];
            b = imageData[p + 2];
            //a = imageData[p + 2];

            var hsl = rgbToHsl(r, g, b);

            h = hsl[0];
            s = hsl[1];
            l = hsl[2];

            //alter the hue of only the red pixels
            var mod, m;
            var found = false;
            for (m = 0; m < modifiers.length; m++) {
                mod = modifiers[m];
                if (h >= mod.low && h <= mod.high) {
                    //console.log(true);
                    found = true;
                    break;
                }
            }
            if (found) {
                h = (h + mod.add - mod.low) % 1;
            }
            
            var rgb = hslToRgb(h, s, l);

            imageData[p] = rgb[0];
            imageData[p + 1] = rgb[1];
            imageData[p + 2] = rgb[2];
        }

        context.putImageData(imageMap, 0, 0);
        img.src = canvas.toDataURL();
        img.width = tagWidth;
    };


    /**
     * Converts an RGB color value to HSL. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
     * Assumes r, g, and b are contained in the set [0, 255] and
     * returns h, s, and l in the set [0, 1].
     *
     * @param   {number}  r       The red color value
     * @param   {number}  g       The green color value
     * @param   {number}  b       The blue color value
     * @return  {Array}           The HSL representation
     */
    var rgbToHsl = function (r, g, b) {
        r /= 255, g /= 255, b /= 255;
        var max = Math.max(r, g, b),
            min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2;

        if (max == min) {
            h = s = 0; // achromatic
        } else {
            var d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
            }
            h /= 6;
        }

        return [h, s, l];
    };

    /**
     * Converts an HSL color value to RGB. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
     * Assumes h, s, and l are contained in the set [0, 1] and
     * returns r, g, and b in the set [0, 255].
     *
     * @param   {number}  h       The hue
     * @param   {number}  s       The saturation
     * @param   {number}  l       The lightness
     * @return  {Array}           The RGB representation
     */
    var hslToRgb = function (h, s, l) {
        var r, g, b;

        if (s == 0) {
            r = g = b = l; // achromatic
        } else {
            var hue2rgb = function hue2rgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1 / 6) return p + (q - p) * 6 * t;
                if (t < 1 / 2) return q;
                if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                return p;
            }

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;
            r = hue2rgb(p, q, h + 1 / 3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1 / 3);
        }
        r = Math.round(r * 255);
        g = Math.round(g * 255);
        b = Math.round(b * 255);

        return [r, g, b];
    };

    var updateSaveData = function () {
        var saveData = {};
        saveData.lions = lions;

        update_game_from_object(saveData);
        save_game_into_cookie();
    };
</script>
<script src=save.js></script>

</html>